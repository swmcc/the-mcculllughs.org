<%
  # Expected locals: title, subtitle, count, drill_path, samples, overflow
  images_data = samples.select { |u| u.file.attached? }.map.with_index do |u, i|
    {
      id: u.id,
      index: i,
      title: u.title,
      caption: u.caption,
      date_taken: u.date_taken&.to_s,
      gallery_title: u.gallery.title,
      gallery_path: gallery_path(u.gallery, anchor: dom_id(u)),
      original: url_for(u.file),
      thumb: upload_variant_url(u, :thumb),
      medium: upload_variant_url(u, :medium),
      large: upload_variant_url(u, :large)
    }
  end
%>

<div class="bg-white rounded-xl shadow-sm overflow-hidden"
     data-controller="search-lightbox"
     data-search-lightbox-images-value="<%= images_data.to_json %>"
     data-action="keydown@window->search-lightbox#keydown">

  <div class="flex items-center gap-4 p-4">
    <!-- Header: clickable to drill down -->
    <%= link_to drill_path, class: "flex-shrink-0 flex items-center gap-3 group" do %>
      <div>
        <h2 class="text-lg font-semibold text-neutral-800 group-hover:text-blue-600 transition-colors">
          <%= title %>
        </h2>
        <p class="text-sm text-neutral-500">
          <%= pluralize(count, 'photo') %>
        </p>
      </div>
      <svg class="w-5 h-5 text-neutral-400 group-hover:text-blue-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    <% end %>

    <!-- Thumbnails: each opens lightbox -->
    <div class="flex-1 flex items-center gap-2 overflow-hidden">
      <% samples.each_with_index do |upload, i| %>
        <% next unless upload.file.attached? %>
        <a href="#"
           data-action="click->search-lightbox#open"
           data-index="<%= i %>"
           class="flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 rounded-lg overflow-hidden bg-neutral-100 hover:ring-2 hover:ring-blue-500 transition-all">
          <%= upload_picture_tag upload, :thumb,
              class: "w-full h-full object-cover",
              loading: "lazy",
              alt: upload.title %>
        </a>
      <% end %>

      <% if overflow > 0 %>
        <%= link_to drill_path, class: "flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 rounded-lg bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-600 font-medium transition-colors" do %>
          +<%= overflow %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Lightbox modal (per-row) -->
  <%= render "timeline/lightbox_modal" %>
</div>
